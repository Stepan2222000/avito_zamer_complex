version: '3.8'

services:
  worker:
    build:
      context: ./container
      dockerfile: Dockerfile
    deploy:
      replicas: 15
    restart: always
    environment:
      # Database
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT:-5417}
      - DB_NAME=${DB_NAME}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}

      # Worker settings
      - WORKER_ID=${HOSTNAME}
      - HEARTBEAT_INTERVAL=${HEARTBEAT_INTERVAL:-120}
      - STUCK_TASK_TIMEOUT=${STUCK_TASK_TIMEOUT:-3600}
      - MAX_RETRY_ATTEMPTS=${MAX_RETRY_ATTEMPTS:-3}
      - NO_TASKS_WAIT=${NO_TASKS_WAIT:-30}
      - NO_PROXIES_WAIT=${NO_PROXIES_WAIT:-60}

      # Pool settings
      - POOL_MIN_SIZE=${POOL_MIN_SIZE:-2}
      - POOL_MAX_SIZE=${POOL_MAX_SIZE:-5}

      # API keys
      - GEMINI_API_KEY=${GEMINI_API_KEY}

      # Display for Playwright (headless=false)
      - DISPLAY=:99

    volumes:
      # X11 для виртуального дисплея
      - /tmp/.X11-unix:/tmp/.X11-unix:rw

    # Увеличенная shared memory для Chromium
    shm_size: 2gb

    # Лимиты ресурсов (опционально)
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 2G

    # Healthcheck (опционально)
    healthcheck:
      test: ["CMD", "python", "-c", "import asyncio; import asyncpg; asyncio.run(asyncpg.connect(host='${DB_HOST}', port=${DB_PORT}, database='${DB_NAME}', user='${DB_USER}', password='${DB_PASSWORD}', timeout=5))"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s

networks:
  default:
    driver: bridge
