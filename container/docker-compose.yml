version: '3.8'

services:
  # Воркеры для парсинга (15 штук по умолчанию)
  # Подключаются к удаленной PostgreSQL БД: 81.30.105.134:5417
  worker:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      # Подключение к удаленной БД
      DB_HOST: ${DB_HOST:-81.30.105.134}
      DB_PORT: ${DB_PORT:-5417}
      DB_NAME: ${DB_NAME:-system_avito_zamer}
      DB_USER: ${DB_USER:-admin}
      DB_PASSWORD: ${DB_PASSWORD:-Password123}

      # Настройки воркера
      HEARTBEAT_INTERVAL: ${HEARTBEAT_INTERVAL:-120}  # 2 минуты
      STUCK_TASK_TIMEOUT: ${STUCK_TASK_TIMEOUT:-3600}  # 1 час
      MAX_RETRY_ATTEMPTS: ${MAX_RETRY_ATTEMPTS:-3}

      # API ключ для ИИ-валидации (OpenAI)
      OPENAI_API_KEY: ${OPENAI_API_KEY}
    deploy:
      replicas: 15  # Запускаем 15 воркеров
      restart_policy:
        condition: on-failure
        delay: 10s
        max_attempts: 3
        window: 120s
    # Автоматический перезапуск при падении
    restart: on-failure
